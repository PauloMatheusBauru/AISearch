<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultor de C√≥digos de Pe√ßas Automotivas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .container-app {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin: 1rem;
        }
        .spinner {
            border-top-color: transparent;
            border-left-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container-app">
    <div class="card w-full max-w-2xl bg-white p-6 md:p-10 rounded-2xl">
        <h1 class="text-3xl font-black text-teal-600 mb-1">
            ‚öôÔ∏è CodeFinder
        </h1>

        <p class="text-gray-500 text-sm border-b pb-4 mb-6">
            Consulta de C√≥digos de Refer√™ncia de Pe√ßas Automotivas.
        </p>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
            <label for="peca-input" class="block text-sm font-bold text-gray-700 mb-2">
                Descri√ß√£o Detalhada da Pe√ßa:
            </label>
            <textarea id="peca-input" rows="3"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150 resize-none shadow-inner"
                placeholder="Exemplo: KIT CABO DE VELA E VELA GOL G5 1.0 8V 2008"
            >KIT AMORTECEDOR PAJERO TR4 2012</textarea>
        </div>

        <button id="consultar-btn"
            class="w-full px-4 py-3 bg-teal-500 text-white font-bold text-lg rounded-lg hover:bg-teal-600 transition duration-300 focus:outline-none focus:ring-4 focus:ring-teal-400 focus:ring-opacity-70 flex items-center justify-center disabled:opacity-50 transform hover:scale-[1.01] shadow-lg shadow-teal-500/50">
            <svg id="loading-spinner" class="spinner h-5 w-5 mr-3 hidden border-4 border-white border-solid rounded-full" viewBox="0 0 24 24"></svg>
            <span id="button-text">Consultar C√≥digos</span>
        </button>

        <div id="resultado" class="mt-8 pt-6 border-t border-gray-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2 text-teal-600">üìä</span> Resultado da Consulta:
            </h2>

            <div id="resultado-content" class="min-h-32 bg-gray-900 p-5 rounded-lg text-teal-300 font-mono text-sm shadow-xl whitespace-pre-wrap overflow-x-auto">
                Digite a descri√ß√£o da pe√ßa acima e clique em "Consultar C√≥digos".
            </div>

            <div id="metadata" class="mt-4 pt-4 border-t border-gray-100 hidden">
                <p class="text-sm font-semibold text-gray-600 mb-2">Detalhes da Consulta (Tokens):</p>
                <div class="flex flex-col sm:flex-row justify-between text-xs text-gray-500 space-y-1 sm:space-y-0">
                    <span id="prompt-tokens" class="font-mono">Tokens de Entrada (Prompt + Instru√ß√£o): 0</span>
                    <span id="output-tokens" class="font-mono">Tokens de Sa√≠da (Resposta): 0</span>
                </div>
            </div>

            <div id="fontes" class="mt-4 hidden">
                <p class="text-sm font-semibold text-gray-600 mb-2">Fontes Consultadas (Busca Web):</p>
                <ul id="fontes-lista" class="list-disc ml-5 text-xs text-gray-500 space-y-1"></ul>
            </div>

            <div class="mt-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow-sm" role="alert">
                <p class="font-bold mb-1">‚ö†Ô∏è Aviso Importante:</p>
                <p class="text-sm">Sempre verifique a compatibilidade no cat√°logo do fabricante ou compare os c√≥digos e o modelo da pe√ßa com a que est√° instalada no seu ve√≠culo antes de finalizar a compra. <b>Esta consulta √© apenas uma refer√™ncia.</b></p>
            </div>
        </div>

        <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg hidden transition-opacity duration-300" role="alert">
            <p id="message-text" class="font-medium"></p>
        </div>
    </div>
</div>

<script>
    const inputPeca = document.getElementById('peca-input');
    const btnConsultar = document.getElementById('consultar-btn');
    const btnText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resultadoContent = document.getElementById('resultado-content');
    const fontesDiv = document.getElementById('fontes');
    const fontesLista = document.getElementById('fontes-lista');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const metadataDiv = document.getElementById('metadata');
    const promptTokensEl = document.getElementById('prompt-tokens');
    const outputTokensEl = document.getElementById('output-tokens');

    function showMessage(message, type = 'info') {
        let classes = '';
        if (type === 'error') {
            classes = 'bg-red-100 text-red-700 border border-red-200';
        } else if (type === 'success') {
            classes = 'bg-green-100 text-green-700 border border-green-200';
        } else if (type === 'warning') {
            classes = 'bg-yellow-100 text-yellow-700 border border-yellow-200';
        } else {
            classes = 'bg-blue-100 text-blue-700 border border-blue-200';
        }

        messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg transition-opacity duration-300 ${classes}`;
        messageText.textContent = message;
        messageBox.classList.remove('hidden');
        setTimeout(() => messageBox.classList.add('hidden'), 4000);
    }

    async function consultarCodigos() {
        const userQuery = inputPeca.value.trim();
        if (!userQuery) {
            showMessage("Por favor, digite a descri√ß√£o da pe√ßa.", 'warning');
            return;
        }

        btnConsultar.disabled = true;
        btnText.textContent = "Buscando...";
        loadingSpinner.classList.remove('hidden');
        resultadoContent.textContent = "Consultando a IA...";

        try {
            const response = await fetch('/consultar_codigos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: userQuery })
            });

            const result = await response.json();

            if (result.error) {
                showMessage(result.message || "Erro ao consultar o servidor.", 'error');
                resultadoContent.textContent = result.message || "Erro interno.";
                return;
            }

            resultadoContent.textContent = result.result_text || "Nenhum resultado encontrado.";
            showMessage("Consulta conclu√≠da!", 'success');

            if (result.usageMetadata) {
                promptTokensEl.textContent = `Tokens de Entrada: ${result.usageMetadata.promptTokenCount}`;
                outputTokensEl.textContent = `Tokens de Sa√≠da: ${result.usageMetadata.outputTokenCount}`;
                metadataDiv.classList.remove('hidden');
            }

            const sources = result.sources || [];
            if (sources.length > 0) {
                fontesLista.innerHTML = '';
                sources.forEach(src => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${src.uri}" target="_blank" class="hover:underline text-blue-400">${src.title}</a>`;
                    fontesLista.appendChild(li);
                });
                fontesDiv.classList.remove('hidden');
            } else {
                fontesDiv.classList.add('hidden');
            }

        } catch (err) {
            showMessage("Erro de conex√£o. Tente novamente.", 'error');
            resultadoContent.textContent = "Falha ao se conectar ao servidor Flask.";
        } finally {
            btnConsultar.disabled = false;
            btnText.textContent = "Consultar C√≥digos";
            loadingSpinner.classList.add('hidden');
        }
    }

    btnConsultar.addEventListener('click', consultarCodigos);
    inputPeca.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey && !btnConsultar.disabled) {
            e.preventDefault();
            consultarCodigos();
        }
    });
</script>
</body>
</html>

